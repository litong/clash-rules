name: Sync Clash Rules

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      sync_folders:
        description: 'è¦åŒæ­¥çš„æ–‡ä»¶å¤¹ (ç”¨é€—å·åˆ†éš”)'
        required: false
        default: ''

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout target repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
    - name: Clone source repository
      run: |
        git clone --depth 1 https://github.com/blackmatrix7/ios_rule_script.git /tmp/ios_rule_script
        
    - name: Read sync configuration
      id: config
      run: |
        if [ -f "sync-config.json" ]; then
          echo "folders=$(cat sync-config.json | jq -c '.folders')" >> $GITHUB_OUTPUT
        else
          echo 'folders=["rules"]' >> $GITHUB_OUTPUT
        fi
        
    - name: Sync specified folders
      run: |
        # åˆ›å»ºå·¥ä½œç›®å½•
        mkdir -p sync_temp
        
        # è·å–è¦åŒæ­¥çš„æ–‡ä»¶å¤¹åˆ—è¡¨
        if [ -n "${{ github.event.inputs.sync_folders }}" ]; then
          FOLDERS=$(echo "${{ github.event.inputs.sync_folders }}" | tr ',' '\n')
        else
          FOLDERS=$(echo '${{ steps.config.outputs.folders }}' | jq -r '.[]')
        fi
        
        echo "è¦åŒæ­¥çš„æ–‡ä»¶å¤¹:"
        echo "$FOLDERS"
        
        # åŒæ­¥æ¯ä¸ªæ–‡ä»¶å¤¹
        for folder in $FOLDERS; do
          echo "æ­£åœ¨åŒæ­¥æ–‡ä»¶å¤¹: $folder"
          
          # æ£€æŸ¥æºæ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
          if [ -d "/tmp/ios_rule_script/rule/Clash/$folder" ]; then
            # åˆ›å»ºç›®æ ‡ç›®å½•
            mkdir -p "$(dirname "rules/$folder")"
            
            # å¤åˆ¶æ–‡ä»¶å¤¹
            cp -r "/tmp/ios_rule_script/rule/Clash/$folder" "rules/$folder"
            
            echo "âœ… å·²åŒæ­¥: $folder"
          else
            echo "âŒ æºæ–‡ä»¶å¤¹ä¸å­˜åœ¨: /tmp/ios_rule_script/rule/Clash/$folder"
          fi
        done
        
        # ç”ŸæˆåŒæ­¥æŠ¥å‘Š
        cat > sync_report.md << 'EOF'
        # Clash è§„åˆ™åŒæ­¥æŠ¥å‘Š
        
        åŒæ­¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
        
        ## åŒæ­¥çš„æ–‡ä»¶å¤¹
        EOF
        
        for folder in $FOLDERS; do
          if [ -d "$folder" ]; then
            file_count=$(find "$folder" -type f | wc -l)
            echo "- âœ… $folder ($file_count ä¸ªæ–‡ä»¶)" >> sync_report.md
          else
            echo "- âŒ $folder (åŒæ­¥å¤±è´¥)" >> sync_report.md
          fi
        done
        
        echo "" >> sync_report.md
        echo "## æäº¤ä¿¡æ¯" >> sync_report.md
        echo "- æºä»“åº“: https://github.com/blackmatrix7/ios_rule_script" >> sync_report.md
        echo "- åŒæ­¥åˆ†æ”¯: master" >> sync_report.md
        
    - name: Commit and push changes
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if [ -n "$(git status --porcelain)" ]; then
          echo "å‘ç°å˜æ›´ï¼Œå¼€å§‹æäº¤..."
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´
          git add .
          
          # åˆ›å»ºæäº¤
          git commit -m "ğŸ”„ åŒæ­¥ Clash è§„åˆ™ ($(date '+%Y-%m-%d %H:%M:%S'))
          
          - è‡ªåŠ¨åŒæ­¥è‡ª: https://github.com/blackmatrix7/ios_rule_script
          - åŒæ­¥æ–‡ä»¶å¤¹: $(echo '${{ steps.config.outputs.folders }}' | jq -r '. | join(", ")')
          
          [skip ci]"
          
          # æ¨é€åˆ°ä»“åº“
          git push
          
          echo "âœ… å˜æ›´å·²æäº¤å¹¶æ¨é€"
        else
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´"
        fi
        
    - name: Upload sync report
      uses: actions/upload-artifact@v4
      with:
        name: sync-report-${{ github.run_number }}
        path: sync_report.md
        retention-days: 30